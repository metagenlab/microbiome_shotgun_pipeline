db_path_ezvir=config["ezvir_database"]

rule all_ezvir_db:
        input:  f"{db_path_ezvir}/EZV0.1-database.1.bt2",
                f"{db_path_ezvir}/EZV0.1-database.2.bt2",
                f"{db_path_ezvir}/EZV0.1-database.3.bt2",
                f"{db_path_ezvir}/EZV0.1-database.4.bt2",
                f"{db_path_ezvir}/EZV0.1-database.rev.1.bt2",
                f"{db_path_ezvir}/EZV0.1-database.rev.2.bt2",
                "Ezvir/genome_lengths.csv",
                "Ezvir/genome_names.csv"


rule decompress_database:
    input: f"{db_path_ezvir}/EZV0.1-database.fasta.gz"

    output: f"{db_path_ezvir}/EZV0.1-database.fa"

    shell: "zcat {input} > {output}"



checkpoint genrate_required_files:
    conda: pipeline_path + "envs/biopython-pandas.yml"

    input: f"{db_path_ezvir}/EZV0.1-database.fa"

    output: "Ezvir/genome_lengths.csv",
            "Ezvir/genome_names.csv"

    script: "required_files.py"



rule index_database:
    conda: pipeline_path + "envs/ezvir.yml"

    input:  f"{db_path_ezvir}/EZV0.1-database.fa"

    output: f"{db_path_ezvir}/EZV0.1-database.1.bt2",
            f"{db_path_ezvir}/EZV0.1-database.2.bt2",
            f"{db_path_ezvir}/EZV0.1-database.3.bt2",
            f"{db_path_ezvir}/EZV0.1-database.4.bt2",
            f"{db_path_ezvir}/EZV0.1-database.rev.1.bt2",
            f"{db_path_ezvir}/EZV0.1-database.rev.2.bt2"

    params: f"{db_path_ezvir}/EZV0.1-database"

    log: logging_folder + "Ezvir/indexing.log"

    threads: 25

    shell: "bowtie2-build --threads {threads} -f {input} {params} &> {log}"